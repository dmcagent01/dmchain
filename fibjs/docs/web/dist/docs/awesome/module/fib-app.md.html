<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=icon type=image/png href=../../../imgs/icon.png><title> fib-app - JavaScript on Fiber</title><link href=../../../css/common.css rel=stylesheet><link href=../../../css/docs.css rel=stylesheet></head><body><div class="navbar navbar-default navbar-static-top" role=navigation><div class=container><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#navbar aria-expanded=false aria-controls=navbar><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href=../../../index.html><img src=../../../imgs/logo-dark.png></a></div><div id=navbar class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right notranslate"><li><a href=../../../index.html>HOME</a></li><li><a href=../../guide/readme.md.html>GUIDE</a></li><li><a href=../../manual/module/readme.md.html>MODULE</a></li><li><a href=../../manual/object/readme.md.html>OBJECT</a></li><li><a href=../readme.md.html>AWESOME</a></li><li><a href=../../../download/index.html>DOWNLOAD</a></li><li class="nav-item dropdown"><a href=# data-toggle=dropdown aria-haspopup=true aria-expanded=false>LANGUAGE</a><div class=dropdown-menu><a href=../../../docs/awesome/module/fib-app.md.html>中文</a> <a href=../../../ca/docs/awesome/module/fib-app.md.html>Catalan</a> <a href=../../../de/docs/awesome/module/fib-app.md.html>Deutsch</a> <a href=../../../en/docs/awesome/module/fib-app.md.html>English</a> <a href=../../../es/docs/awesome/module/fib-app.md.html>Español</a> <a href=../../../fr/docs/awesome/module/fib-app.md.html>Français</a> <a href=../../../gl/docs/awesome/module/fib-app.md.html>Galego</a> <a href=../../../it/docs/awesome/module/fib-app.md.html>Italiano</a> <a href=../../../ru/docs/awesome/module/fib-app.md.html>Русский</a> <a href=../../../ja/docs/awesome/module/fib-app.md.html>日本語</a> <a href=../../../ko/docs/awesome/module/fib-app.md.html>한국어</a> <a href=../../../zh-tw/docs/awesome/module/fib-app.md.html>繁體中文</a></div></li></ul></div></div></div><div class=band><div class=container><span class=group> Awesome 社区模块 </span><div class=search><input type=text class=searchbox placeholder=Search></div></div></div><div class=container><ol class=breadcrumb><li><a href=../../../index.html>首页</a></li><li><a href=../readme.md.html> 社区模块 </a></li><li class=active> fib-app </li></ol></div><div class=page-body><div class=container><div class="sidebar hidden-xs"><div class=panel-group id=accordion role=tablist>  <div class=panel><div class=panel-heading role=tab id=headingOne><h4 class=panel-title><a data-toggle=collapse data-parent=#accordion href="#collapse_guide" aria-controls="collapse_guide"> 开发指南 </a></h4></div><div id="collapse_guide" class="panel-collapse collapse " aria-labelledby=headingOne><div class=panel-body> <ul>
<li><a href=../../guide/about.md.html>fibjs 是什么？</a></li>
<li><a href=../../guide/install.md.html>安装运行环境</a></li>
<li><a href=../../guide/hello.md.html class ="notranslate">hello, world</a></li>
<li><a href=../../guide/test.md.html>美好生活从测试开始</a></li>
<li><a href=../../guide/profiler.md.html>找出性能杀手</a></li>
<li><a href=../../guide/server-hot-update.md.html>服务端模块热更新</a></li>
<li><a href=../../guide/host-routes.md.html>域名路由</a></li>
<li><a href=../../guide/x509.md.html>fibjs 中 X509 证书的使用</a></li>
<li><a href=../../guide/contribute.md.html>添加 native 模块</a></li>
</ul>
 </div></div></div>  <div class=panel><div class=panel-heading role=tab id=headingOne><h4 class=panel-title><a data-toggle=collapse data-parent=#accordion href="#collapse_module" aria-controls="collapse_module"> 基础模块 </a></h4></div><div id="collapse_module" class="panel-collapse collapse " aria-labelledby=headingOne><div class=panel-body> <ul>
<li><a href=../../manual/module/ifs/assert.md.html class ="notranslate">assert</a></li>
<li><a href=../../manual/module/ifs/base32.md.html class ="notranslate">base32</a></li>
<li><a href=../../manual/module/ifs/base58.md.html class ="notranslate">base58</a></li>
<li><a href=../../manual/module/ifs/base64.md.html class ="notranslate">base64</a></li>
<li><a href=../../manual/module/ifs/child_process.md.html class ="notranslate">child_process</a></li>
<li><a href=../../manual/module/ifs/console.md.html class ="notranslate">console</a></li>
<li><a href=../../manual/module/ifs/constants.md.html class ="notranslate">constants</a></li>
<li><a href=../../manual/module/ifs/coroutine.md.html class ="notranslate">coroutine</a></li>
<li><a href=../../manual/module/ifs/crypto.md.html class ="notranslate">crypto</a></li>
<li><a href=../../manual/module/ifs/db.md.html class ="notranslate">db</a></li>
<li><a href=../../manual/module/ifs/dgram.md.html class ="notranslate">dgram</a></li>
<li><a href=../../manual/module/ifs/dns.md.html class ="notranslate">dns</a></li>
<li><a href=../../manual/module/ifs/encoding.md.html class ="notranslate">encoding</a></li>
<li><a href=../../manual/module/ifs/fs.md.html class ="notranslate">fs</a></li>
<li><a href=../../manual/module/ifs/fs_constants.md.html class ="notranslate">fs_constants</a></li>
<li><a href=../../manual/module/ifs/gd.md.html class ="notranslate">gd</a></li>
<li><a href=../../manual/module/ifs/global.md.html class ="notranslate">global</a></li>
<li><a href=../../manual/module/ifs/gui.md.html class ="notranslate">gui</a></li>
<li><a href=../../manual/module/ifs/hash.md.html class ="notranslate">hash</a></li>
<li><a href=../../manual/module/ifs/hex.md.html class ="notranslate">hex</a></li>
<li><a href=../../manual/module/ifs/http.md.html class ="notranslate">http</a></li>
<li><a href=../../manual/module/ifs/iconv.md.html class ="notranslate">iconv</a></li>
<li><a href=../../manual/module/ifs/io.md.html class ="notranslate">io</a></li>
<li><a href=../../manual/module/ifs/json.md.html class ="notranslate">json</a></li>
<li><a href=../../manual/module/ifs/mq.md.html class ="notranslate">mq</a></li>
<li><a href=../../manual/module/ifs/msgpack.md.html class ="notranslate">msgpack</a></li>
<li><a href=../../manual/module/ifs/multibase.md.html class ="notranslate">multibase</a></li>
<li><a href=../../manual/module/ifs/net.md.html class ="notranslate">net</a></li>
<li><a href=../../manual/module/ifs/os.md.html class ="notranslate">os</a></li>
<li><a href=../../manual/module/ifs/path.md.html class ="notranslate">path</a></li>
<li><a href=../../manual/module/ifs/path_posix.md.html class ="notranslate">path_posix</a></li>
<li><a href=../../manual/module/ifs/path_win32.md.html class ="notranslate">path_win32</a></li>
<li><a href=../../manual/module/ifs/perf_hooks.md.html class ="notranslate">perf_hooks</a></li>
<li><a href=../../manual/module/ifs/performance.md.html class ="notranslate">performance</a></li>
<li><a href=../../manual/module/ifs/process.md.html class ="notranslate">process</a></li>
<li><a href=../../manual/module/ifs/profiler.md.html class ="notranslate">profiler</a></li>
<li><a href=../../manual/module/ifs/punycode.md.html class ="notranslate">punycode</a></li>
<li><a href=../../manual/module/ifs/querystring.md.html class ="notranslate">querystring</a></li>
<li><a href=../../manual/module/ifs/registry.md.html class ="notranslate">registry</a></li>
<li><a href=../../manual/module/ifs/ssl.md.html class ="notranslate">ssl</a></li>
<li><a href=../../manual/module/ifs/string_decoder.md.html class ="notranslate">string_decoder</a></li>
<li><a href=../../manual/module/ifs/test.md.html class ="notranslate">test</a></li>
<li><a href=../../manual/module/ifs/timers.md.html class ="notranslate">timers</a></li>
<li><a href=../../manual/module/ifs/tty.md.html class ="notranslate">tty</a></li>
<li><a href=../../manual/module/ifs/url.md.html class ="notranslate">url</a></li>
<li><a href=../../manual/module/ifs/util.md.html class ="notranslate">util</a></li>
<li><a href=../../manual/module/ifs/uuid.md.html class ="notranslate">uuid</a></li>
<li><a href=../../manual/module/ifs/vm.md.html class ="notranslate">vm</a></li>
<li><a href=../../manual/module/ifs/worker_threads.md.html class ="notranslate">worker_threads</a></li>
<li><a href=../../manual/module/ifs/ws.md.html class ="notranslate">ws</a></li>
<li><a href=../../manual/module/ifs/xml.md.html class ="notranslate">xml</a></li>
<li><a href=../../manual/module/ifs/zip.md.html class ="notranslate">zip</a></li>
<li><a href=../../manual/module/ifs/zlib.md.html class ="notranslate">zlib</a></li>
</ul>
 </div></div></div>  <div class=panel><div class=panel-heading role=tab id=headingOne><h4 class=panel-title><a data-toggle=collapse data-parent=#accordion href="#collapse_object" aria-controls="collapse_object"> 内置对象 </a></h4></div><div id="collapse_object" class="panel-collapse collapse " aria-labelledby=headingOne><div class=panel-body> <ul>
<li><a href=../../manual/object/ifs/buffer.md.html class ="notranslate">Buffer</a></li>
<li><a href=../../manual/object/ifs/bufferedstream.md.html class ="notranslate">BufferedStream</a></li>
<li><a href=../../manual/object/ifs/chain.md.html class ="notranslate">Chain</a></li>
<li><a href=../../manual/object/ifs/childprocess.md.html class ="notranslate">ChildProcess</a></li>
<li><a href=../../manual/object/ifs/cipher.md.html class ="notranslate">Cipher</a></li>
<li><a href=../../manual/object/ifs/condition.md.html class ="notranslate">Condition</a></li>
<li><a href=../../manual/object/ifs/dbconnection.md.html class ="notranslate">DbConnection</a></li>
<li><a href=../../manual/object/ifs/dgramsocket.md.html class ="notranslate">DgramSocket</a></li>
<li><a href=../../manual/object/ifs/digest.md.html class ="notranslate">Digest</a></li>
<li><a href=../../manual/object/ifs/event.md.html class ="notranslate">Event</a></li>
<li><a href=../../manual/object/ifs/eventemitter.md.html class ="notranslate">EventEmitter</a></li>
<li><a href=../../manual/object/ifs/fswatcher.md.html class ="notranslate">FSWatcher</a></li>
<li><a href=../../manual/object/ifs/fiber.md.html class ="notranslate">Fiber</a></li>
<li><a href=../../manual/object/ifs/file.md.html class ="notranslate">File</a></li>
<li><a href=../../manual/object/ifs/handler.md.html class ="notranslate">Handler</a></li>
<li><a href=../../manual/object/ifs/heapgraphedge.md.html class ="notranslate">HeapGraphEdge</a></li>
<li><a href=../../manual/object/ifs/heapgraphnode.md.html class ="notranslate">HeapGraphNode</a></li>
<li><a href=../../manual/object/ifs/heapsnapshot.md.html class ="notranslate">HeapSnapshot</a></li>
<li><a href=../../manual/object/ifs/httpclient.md.html class ="notranslate">HttpClient</a></li>
<li><a href=../../manual/object/ifs/httpcollection.md.html class ="notranslate">HttpCollection</a></li>
<li><a href=../../manual/object/ifs/httpcookie.md.html class ="notranslate">HttpCookie</a></li>
<li><a href=../../manual/object/ifs/httphandler.md.html class ="notranslate">HttpHandler</a></li>
<li><a href=../../manual/object/ifs/httpmessage.md.html class ="notranslate">HttpMessage</a></li>
<li><a href=../../manual/object/ifs/httprepeater.md.html class ="notranslate">HttpRepeater</a></li>
<li><a href=../../manual/object/ifs/httprequest.md.html class ="notranslate">HttpRequest</a></li>
<li><a href=../../manual/object/ifs/httpresponse.md.html class ="notranslate">HttpResponse</a></li>
<li><a href=../../manual/object/ifs/httpserver.md.html class ="notranslate">HttpServer</a></li>
<li><a href=../../manual/object/ifs/httpuploaddata.md.html class ="notranslate">HttpUploadData</a></li>
<li><a href=../../manual/object/ifs/httpsserver.md.html class ="notranslate">HttpsServer</a></li>
<li><a href=../../manual/object/ifs/image.md.html class ="notranslate">Image</a></li>
<li><a href=../../manual/object/ifs/iterator.md.html class ="notranslate">Iterator</a></li>
<li><a href=../../manual/object/ifs/leveldb.md.html class ="notranslate">LevelDB</a></li>
<li><a href=../../manual/object/ifs/lock.md.html class ="notranslate">Lock</a></li>
<li><a href=../../manual/object/ifs/lrucache.md.html class ="notranslate">LruCache</a></li>
<li><a href=../../manual/object/ifs/memorystream.md.html class ="notranslate">MemoryStream</a></li>
<li><a href=../../manual/object/ifs/message.md.html class ="notranslate">Message</a></li>
<li><a href=../../manual/object/ifs/mongocollection.md.html class ="notranslate">MongoCollection</a></li>
<li><a href=../../manual/object/ifs/mongocursor.md.html class ="notranslate">MongoCursor</a></li>
<li><a href=../../manual/object/ifs/mongodb.md.html class ="notranslate">MongoDB</a></li>
<li><a href=../../manual/object/ifs/mongoid.md.html class ="notranslate">MongoID</a></li>
<li><a href=../../manual/object/ifs/mysql.md.html class ="notranslate">MySQL</a></li>
<li><a href=../../manual/object/ifs/odbc.md.html class ="notranslate">Odbc</a></li>
<li><a href=../../manual/object/ifs/pkey.md.html class ="notranslate">PKey</a></li>
<li><a href=../../manual/object/ifs/rangestream.md.html class ="notranslate">RangeStream</a></li>
<li><a href=../../manual/object/ifs/redis.md.html class ="notranslate">Redis</a></li>
<li><a href=../../manual/object/ifs/redishash.md.html class ="notranslate">RedisHash</a></li>
<li><a href=../../manual/object/ifs/redislist.md.html class ="notranslate">RedisList</a></li>
<li><a href=../../manual/object/ifs/redisset.md.html class ="notranslate">RedisSet</a></li>
<li><a href=../../manual/object/ifs/redissortedset.md.html class ="notranslate">RedisSortedSet</a></li>
<li><a href=../../manual/object/ifs/routing.md.html class ="notranslate">Routing</a></li>
<li><a href=../../manual/object/ifs/sqlite.md.html class ="notranslate">SQLite</a></li>
<li><a href=../../manual/object/ifs/sandbox.md.html class ="notranslate">SandBox</a></li>
<li><a href=../../manual/object/ifs/seekablestream.md.html class ="notranslate">SeekableStream</a></li>
<li><a href=../../manual/object/ifs/semaphore.md.html class ="notranslate">Semaphore</a></li>
<li><a href=../../manual/object/ifs/service.md.html class ="notranslate">Service</a></li>
<li><a href=../../manual/object/ifs/smtp.md.html class ="notranslate">Smtp</a></li>
<li><a href=../../manual/object/ifs/socket.md.html class ="notranslate">Socket</a></li>
<li><a href=../../manual/object/ifs/sslhandler.md.html class ="notranslate">SslHandler</a></li>
<li><a href=../../manual/object/ifs/sslserver.md.html class ="notranslate">SslServer</a></li>
<li><a href=../../manual/object/ifs/sslsocket.md.html class ="notranslate">SslSocket</a></li>
<li><a href=../../manual/object/ifs/stat.md.html class ="notranslate">Stat</a></li>
<li><a href=../../manual/object/ifs/statswatcher.md.html class ="notranslate">StatsWatcher</a></li>
<li><a href=../../manual/object/ifs/stream.md.html class ="notranslate">Stream</a></li>
<li><a href=../../manual/object/ifs/stringdecoder.md.html class ="notranslate">StringDecoder</a></li>
<li><a href=../../manual/object/ifs/ttyinputstream.md.html class ="notranslate">TTYInputStream</a></li>
<li><a href=../../manual/object/ifs/ttyoutputstream.md.html class ="notranslate">TTYOutputStream</a></li>
<li><a href=../../manual/object/ifs/tcpserver.md.html class ="notranslate">TcpServer</a></li>
<li><a href=../../manual/object/ifs/textdecoder.md.html class ="notranslate">TextDecoder</a></li>
<li><a href=../../manual/object/ifs/textencoder.md.html class ="notranslate">TextEncoder</a></li>
<li><a href=../../manual/object/ifs/timer.md.html class ="notranslate">Timer</a></li>
<li><a href=../../manual/object/ifs/urlobject.md.html class ="notranslate">UrlObject</a></li>
<li><a href=../../manual/object/ifs/websocket.md.html class ="notranslate">WebSocket</a></li>
<li><a href=../../manual/object/ifs/websocketmessage.md.html class ="notranslate">WebSocketMessage</a></li>
<li><a href=../../manual/object/ifs/webview.md.html class ="notranslate">WebView</a></li>
<li><a href=../../manual/object/ifs/worker.md.html class ="notranslate">Worker</a></li>
<li><a href=../../manual/object/ifs/x509cert.md.html class ="notranslate">X509Cert</a></li>
<li><a href=../../manual/object/ifs/x509crl.md.html class ="notranslate">X509Crl</a></li>
<li><a href=../../manual/object/ifs/x509req.md.html class ="notranslate">X509Req</a></li>
<li><a href=../../manual/object/ifs/xmlattr.md.html class ="notranslate">XmlAttr</a></li>
<li><a href=../../manual/object/ifs/xmlcdatasection.md.html class ="notranslate">XmlCDATASection</a></li>
<li><a href=../../manual/object/ifs/xmlcharacterdata.md.html class ="notranslate">XmlCharacterData</a></li>
<li><a href=../../manual/object/ifs/xmlcomment.md.html class ="notranslate">XmlComment</a></li>
<li><a href=../../manual/object/ifs/xmldocument.md.html class ="notranslate">XmlDocument</a></li>
<li><a href=../../manual/object/ifs/xmldocumenttype.md.html class ="notranslate">XmlDocumentType</a></li>
<li><a href=../../manual/object/ifs/xmlelement.md.html class ="notranslate">XmlElement</a></li>
<li><a href=../../manual/object/ifs/xmlnamednodemap.md.html class ="notranslate">XmlNamedNodeMap</a></li>
<li><a href=../../manual/object/ifs/xmlnode.md.html class ="notranslate">XmlNode</a></li>
<li><a href=../../manual/object/ifs/xmlnodelist.md.html class ="notranslate">XmlNodeList</a></li>
<li><a href=../../manual/object/ifs/xmlprocessinginstruction.md.html class ="notranslate">XmlProcessingInstruction</a></li>
<li><a href=../../manual/object/ifs/xmltext.md.html class ="notranslate">XmlText</a></li>
<li><a href=../../manual/object/ifs/zipfile.md.html class ="notranslate">ZipFile</a></li>
<li><a href=../../manual/object/ifs/object.md.html class ="notranslate">object</a></li>
</ul>
 </div></div></div>  <div class=panel><div class=panel-heading role=tab id=headingOne><h4 class=panel-title><a data-toggle=collapse data-parent=#accordion href="#collapse_awesome" aria-controls="collapse_awesome"> 社区模块 </a></h4></div><div id="collapse_awesome" class="panel-collapse collapse in" aria-labelledby=headingOne><div class=panel-body> <ul>
<li><a href=fib-session.md.html class ="notranslate">fib-session</a></li>
<li><a href=fib-pool.md.html class ="notranslate">fib-pool</a></li>
<li><a href=fib-orm.md.html class ="notranslate">fib-orm</a></li>
<li class="active"><a href=fib-app.md.html class ="notranslate">fib-app</a></li>
<li><a href=fib-kv.md.html class ="notranslate">fib-kv</a></li>
<li><a href=fib-rpc.md.html class ="notranslate">fib-rpc</a></li>
<li><a href=fib-qr.md.html class ="notranslate">fib-qr</a></li>
<li><a href=fib-pug.md.html class ="notranslate">fib-pug</a></li>
<li><a href=ejs.md.html class ="notranslate">ejs</a></li>
<li><a href=juicer.md.html class ="notranslate">Juicer</a></li>
<li><a href=highlight.js.md.html class ="notranslate">highlight.js</a></li>
<li><a href=marked.md.html class ="notranslate">marked</a></li>
<li><a href=node-cron.md.html class ="notranslate">node-cron</a></li>
<li><a href=debug.md.html class ="notranslate">debug</a></li>
<li><a href=benchmark.js.md.html class ="notranslate">benchmark.js</a></li>
<li><a href=sinon.md.html class ="notranslate">sinon</a></li>
<li><a href=node-mime.md.html class ="notranslate">node-mime</a></li>
<li><a href=validatorjs.md.html class ="notranslate">validatorjs</a></li>
<li><a href=superstruct.md.html class ="notranslate">superstruct</a></li>
<li><a href=cluster-server.md.html class ="notranslate">cluster-server</a></li>
<li><a href=synaptic.md.html class ="notranslate">synaptic</a></li>
<li><a href=source-map.md.html class ="notranslate">source-map</a></li>
<li><a href=json-format.md.html class ="notranslate">json-format</a></li>
<li><a href=viz.js.md.html class ="notranslate">viz.js</a></li>
<li><a href=nomnoml.md.html class ="notranslate">nomnoml</a></li>
<li><a href=pegjs.md.html class ="notranslate">pegjs</a></li>
<li><a href=uglify-js.md.html class ="notranslate">uglify-js</a></li>
<li><a href=js-beautify.md.html class ="notranslate">js-beautify</a></li>
<li><a href=chalk-animation.md.html class ="notranslate">chalk-animation</a></li>
<li><a href=jsrsasign.md.html class ="notranslate">jsrsasign</a></li>
<li><a href=crypto-js.md.html class ="notranslate">crypto-js</a></li>
<li><a href=ascii-table.md.html class ="notranslate">ascii-table</a></li>
<li><a href=logstream.md.html class ="notranslate">logstream</a></li>
<li><a href=ci.md.html class ="notranslate">ci</a></li>
<li><a href=fs-readdir-recursive.md.html class ="notranslate">fs-readdir-recursive</a></li>
<li><a href=mkdirp.md.html class ="notranslate">mkdirp</a></li>
<li><a href=rmdirr.md.html class ="notranslate">rmdirr</a></li>
<li><a href=detect-port.md.html class ="notranslate">detect-port</a></li>
<li><a href=bitcoinjs-lib.md.html class ="notranslate">bitcoinjs-lib</a></li>
<li><a href=rakuten.md.html class ="notranslate">Rakuten</a></li>
</ul>
 </div></div></div>  </div></div><div class=content><div class=social-share data-sites=weibo,twitter data-description=分享></div> <h1 id="fib-app">fib-app</h1>
<p>fibjs 应用程序基础 api 框架</p>
<h2 id="Install">Install</h2>
<pre><code class="lang-sh"><div class="line-numbers">1</div>npm install fib-app [--save]
</code></pre>
<h2 id="Test">Test</h2>
<pre><code class="lang-sh"><div class="line-numbers">1</div>npm <span class="hljs-built_in">test</span>
</code></pre>
<h2 id="建立基础脚本">建立基础脚本</h2>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</div><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">const</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">const</span> Session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fib-session'</span>)
<span class="hljs-keyword">const</span> App = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>);

<span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> App(<span class="hljs-string">'sqlite:test.db'</span>, {
  <span class="hljs-attr">uuid</span>: <span class="hljs-literal">true</span>
});
app.db.use(<span class="hljs-built_in">require</span>(<span class="hljs-string">'./defs/person'</span>));

<span class="hljs-keyword">var</span> session = <span class="hljs-keyword">new</span> Session(<span class="hljs-keyword">new</span> util.LruCache(<span class="hljs-number">20000</span>), {
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
});

<span class="hljs-keyword">var</span> svr = <span class="hljs-keyword">new</span> http.Server(<span class="hljs-number">8080</span>, [
  session.cookie_filter,
  {
    <span class="hljs-string">'/1.0'</span>: app
  }
]);
svr.run();
</code></pre>
<p>其中 <code>person</code> 是 Model 定义模块，内容如下：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7</div><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">db</span> =&gt;</span> {
  db.define(<span class="hljs-string">'person'</span>, {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-attr">sex</span>: [<span class="hljs-string">"male"</span>, <span class="hljs-string">"female"</span>],
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">Number</span>
  });
};
</code></pre>
<p>这是一个标准的 orm 定义，同样可以使用 orm 的其它功能，比如类型检查，事件等。</p>
<h2 id="API-数据格式">API 数据格式</h2>
<p>对于 POST 和 PUT 请求，请求的主体必须是 JSON 格式，而且 HTTP header 的 Content-Type 需要设置为 application/json。</p>
<pre><code class="lang-sh"><div class="line-numbers">1
2
3
4</div>curl -X PUT \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"name": "tom","sex":"male","age":23}'</span> \
  http://localhost/1.0/person/57fbbdb0a2400000
</code></pre>
<p>对于所有的请求，响应格式都是一个 JSON 对象。</p>
<p>一个请求是否成功是由 HTTP 状态码标明的。一个 2XX 的状态码表示成功，而一个 4XX 表示请求失败。当一个请求失败时响应的主体仍然是一个 JSON 对象，但是总是会包含 code 和 message 这两个字段，你可以用它们来进行调试。举个例子，如果一个请求权限认证失败，会返回以下信息：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4</div>{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">4030501</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"The operation isn’t allowed for clients due to class-level permissions."</span>
}
</code></pre>
<p>code 编码分为三个部分，前三位 403 表示错误类型，05 表示数据表编号，01 表示详细错误编码。</p>
<p>对于 GET 请求，通常会返回对象数据，根据 GET 请求的地址不同，可能会返回一个对象，也可能会返回一个数组。比如：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5</div>{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"tom"</span>,
  <span class="hljs-string">"sex"</span>: <span class="hljs-string">"male"</span>,
  <span class="hljs-string">"age"</span>: <span class="hljs-number">23</span>
}
</code></pre>
<p>或者：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8
9
10
11
12</div>[
  {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"tom"</span>,
    <span class="hljs-string">"sex"</span>: <span class="hljs-string">"male"</span>,
    <span class="hljs-string">"age"</span>: <span class="hljs-number">23</span>
  },
  {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"lily"</span>,
    <span class="hljs-string">"sex"</span>: <span class="hljs-string">"female"</span>,
    <span class="hljs-string">"age"</span>: <span class="hljs-number">22</span>
  }
]
</code></pre>
<h2 id="特殊字段">特殊字段</h2>
<p>对象数据中，有四个特殊含义的字段，是不允许通过 API 更改的。分别是 <code>id</code>, <code>updatedAt</code>, <code>createdAt</code>, <code>createdBy</code>。</p>
<p>其中 <code>id</code>, <code>updatedAt</code>, <code>createdAt</code> 单个字段会自动创建和修改。<code>createdBy</code> 则需要自行指定类型。</p>
<h2 id="基础对象访问-API">基础对象访问 API</h2>
<p>完成这样的数据定义，便直接拥有了一整套符合 REST api 规范的接口调用：</p>
<table>
<thead>
<tr>
<th>url</th>
<th>method</th>
<th>action</th>
</tr>
</thead>
<tbody>
<tr>
<td>/1.0/:className</td>
<td>POST</td>
<td>创建新对象</td>
</tr>
<tr>
<td>/1.0/:className/:id</td>
<td>GET</td>
<td>读取对象</td>
</tr>
<tr>
<td>/1.0/:className/:id</td>
<td>PUT</td>
<td>修改对象</td>
</tr>
<tr>
<td>/1.0/:className/:id</td>
<td>DELETE</td>
<td>删除对象</td>
</tr>
<tr>
<td>/1.0/:className</td>
<td>GET</td>
<td>查询对象列表</td>
</tr>
</tbody>
</table>
<h3 id="创建新对象">创建新对象</h3>
<p>为了创建一个新的对象，应该向 class 的 URL 发送一个 POST 请求，其中应该包含对象本身。例如，要创建如上所说的对象：</p>
<pre><code class="lang-sh"><div class="line-numbers">1
2
3
4</div>curl -X POST \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"name": "tom","sex":"male","age":23}'</span> \
  http://localhost/1.0/person
</code></pre>
<p>当创建成功时，HTTP 的返回是 201 Created，响应的主体是一个 JSON 对象，包含新的对象的 objectId 和 createdAt 时间戳：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4</div>{
  <span class="hljs-string">"createdAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"57fbbdb0a2400000"</span>
}
</code></pre>
<h3 id="读取对象">读取对象</h3>
<p>当你创建了一个对象时，你可以通过发送一个 GET 请求到返回的 header 的 Location 以获取它的内容。例如，为了得到我们上面创建的对象：</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person/57fbbdb0a2400000
</code></pre>
<p>返回的主体是一个 JSON 对象包含所有用户提供的 field 加上 <code>createdAt</code>、<code>updatedAt</code> 和 <code>id</code> 字段：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8</div>{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"tom"</span>,
  <span class="hljs-string">"sex"</span>: <span class="hljs-string">"male"</span>,
  <span class="hljs-string">"age"</span>: <span class="hljs-number">23</span>,
  <span class="hljs-string">"createdAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
  <span class="hljs-string">"updatedAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"57fbbdb0a2400000"</span>
}
</code></pre>
<p>通过设置返回字段 <code>keys</code>，可以定制返回的内容，<code>keys</code> 的内容是一个以 <code>,</code> 分割的字段名称字符串，：</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person/57fbbdb0a2400000?keys=name%2Csex
</code></pre>
<p>将返回：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4</div>{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"tom"</span>,
  <span class="hljs-string">"sex"</span>: <span class="hljs-string">"male"</span>
}
</code></pre>
<h3 id="修改对象">修改对象</h3>
<p>为了更改一个对象已经有的数据，你可以发送一个 PUT 请求到对象相应的 URL 上，任何你未指定的 key 都不会更改，所以你可以只更新对象数据的一个子集。例如，我们来更改我们对象的一个 age 字段：</p>
<pre><code class="lang-sh"><div class="line-numbers">1
2
3
4</div>curl -X PUT \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"age": 25}'</span> \
  http://localhost/1.0/person/57fbbdb0a2400000
</code></pre>
<p>返回的 JSON 对象会包含 <code>updatedAt</code> 和 <code>id</code> 字段，表明更新发生的时间：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4</div>{
  <span class="hljs-string">"updatedAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"57fbbdb0a2400000"</span>
}
</code></pre>
<h3 id="删除对象">删除对象</h3>
<p>为了删除一个对象，可以发送一个 DELETE 请求到指定的对象的 URL，比如：</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X DELETE http://localhost/1.0/person/57fbbdb0a2400000
</code></pre>
<h3 id="查询对象列表">查询对象列表</h3>
<p>通过发送一个 GET 请求到类的 URL 上，不需要任何 URL 参数，你就可以一次获取多个对象。下面就是简单地获取所有用户：</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person
</code></pre>
<p>返回的值就是一个 JSON 对象包含了 results 字段，它的值就是对象的列表：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</div>[
  {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"tom"</span>,
    <span class="hljs-string">"sex"</span>: <span class="hljs-string">"male"</span>,
    <span class="hljs-string">"age"</span>: <span class="hljs-number">23</span>,
    <span class="hljs-string">"createdAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
    <span class="hljs-string">"updatedAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"57fbbdb0a2400000"</span>
  },
  {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"lily"</span>,
    <span class="hljs-string">"sex"</span>: <span class="hljs-string">"female"</span>,
    <span class="hljs-string">"age"</span>: <span class="hljs-number">22</span>,
    <span class="hljs-string">"createdAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
    <span class="hljs-string">"updatedAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"57fbbdb0a2400001"</span>
  }
]
</code></pre>
<h4 id="keys-字段定制">keys 字段定制</h4>
<p>与对象查询一样，查询列表时可以通过设定 <code>keys</code> 来定制返回结果所包含的字段。<code>keys</code> 的内容是一个以 <code>,</code> 分割的字段名称字符串，例如：</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person?keys=name%2Cage
</code></pre>
<p>将指定只返回 <code>name</code> 和 <code>age</code> 两个字段。</p>
<h4 id="where-过滤条件">where 过滤条件</h4>
<p>通过 <code>where</code> 参数的形式可以对查询对象做出约束。</p>
<p><code>where</code> 参数的值应该是 JSON 编码过的。就是说，如果你查看真正被发出的 URL 请求，它应该是先被 JSON 编码过，然后又被 URL 编码过。最简单的使用 <code>where</code> 参数的方式就是包含应有的 key 和 value。例如，如果我们想要搜索名字为 tom 的用户，我们应该这样构造查询:</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person?<span class="hljs-built_in">where</span>=%7B%22name%22%3A%22tom%22%7D
</code></pre>
<p><code>where</code> 的值为一个 urlencode 后的 JSON 字符串，内容为：<code>{&quot;name&quot;:&quot;tom&quot;}</code></p>
<p>除了完全匹配一个给定的值以外，<code>where</code> 也支持比较的方式，比如包含。<code>where</code> 参数支持如下选项：</p>
<table>
<thead>
<tr>
<th>key</th>
<th>operation</th>
<th>sample</th>
</tr>
</thead>
<tbody>
<tr>
<td>eq</td>
<td>等于</td>
<td>{&quot;name&quot;:{&quot;eq&quot;:&quot;tom&quot;}} 或者 {&quot;name&quot;:&quot;tom&quot;}</td>
</tr>
<tr>
<td>ne</td>
<td>不等于</td>
<td>{&quot;name&quot;:{&quot;ne&quot;:&quot;tom&quot;}}</td>
</tr>
<tr>
<td>gt</td>
<td>大于</td>
<td>{&quot;age&quot;:{&quot;gt&quot;:&quot;24&quot;}}</td>
</tr>
<tr>
<td>gte</td>
<td>大于等于</td>
<td>{&quot;age&quot;:{&quot;gte&quot;:&quot;24&quot;}}</td>
</tr>
<tr>
<td>lt</td>
<td>小于</td>
<td>{&quot;age&quot;:{&quot;lt&quot;:&quot;24&quot;}}</td>
</tr>
<tr>
<td>lte</td>
<td>小于等于</td>
<td>{&quot;age&quot;:{&quot;lte&quot;:&quot;24&quot;}}</td>
</tr>
<tr>
<td>like</td>
<td>模糊查询</td>
<td>{&quot;name&quot;:{&quot;like&quot;:&quot;%m&quot;}}</td>
</tr>
<tr>
<td>not_like</td>
<td>模糊查询</td>
<td>{&quot;name&quot;:{&quot;not_like&quot;:&quot;%m&quot;}}</td>
</tr>
<tr>
<td>between</td>
<td>区间比较</td>
<td>{&quot;age&quot;:{&quot;between&quot;:[22,25]}}</td>
</tr>
<tr>
<td>not_between</td>
<td>区间比较</td>
<td>{&quot;age&quot;:{&quot;not_between&quot;:[22,25]}}</td>
</tr>
<tr>
<td>in</td>
<td>枚举</td>
<td>{&quot;name&quot;:{&quot;in&quot;:[&quot;tom&quot;,&quot;lily&quot;]}}</td>
</tr>
<tr>
<td>not_in</td>
<td>枚举</td>
<td>{&quot;name&quot;:{&quot;not_in&quot;:[&quot;tom&quot;,&quot;lily&quot;]}}</td>
</tr>
<tr>
<td>or</td>
<td>或运算</td>
<td>{&quot;or&quot;:[{&quot;name&quot;:&quot;tom&quot;},{&quot;age&quot;:24}]}</td>
</tr>
</tbody>
</table>
<h4 id="skip-跳过记录">skip 跳过记录</h4>
<p>通过 <code>skip</code> 选项，可以跳过指定的记录数，达到翻页的效果。</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person?skip=100
</code></pre>
<h4 id="limit-返回记录限制">limit 返回记录限制</h4>
<p>通过 <code>limit</code> 选项，可以限制返回记录数，<code>limit</code> 的有效数字为 1-1000，缺省为 100。</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person?<span class="hljs-built_in">limit</span>=100
</code></pre>
<h4 id="order-指定排序方式">order 指定排序方式</h4>
<p>通过 <code>order</code> 选项，设定返回结果集的排序方式，字段名前包含 <code>-</code> 时为倒序。</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person?order=-id
</code></pre>
<h4 id="count-返回结果总数">count 返回结果总数</h4>
<p>在请求时增加 <code>count</code> 可以在返回指定内容的同时返回结果集的总数。</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person?count=1&amp;<span class="hljs-built_in">limit</span>=1
</code></pre>
<p>此时返回结果将包含 <code>count</code> 和 <code>results</code> 两个字段，分别包含总数和结果：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8
9
10
11
12
13</div>{
  <span class="hljs-string">"count"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"results"</span>: [
    {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"tom"</span>,
      <span class="hljs-string">"sex"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-string">"age"</span>: <span class="hljs-number">23</span>,
      <span class="hljs-string">"createdAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
      <span class="hljs-string">"updatedAt"</span>: <span class="hljs-string">"2017-11-25T01:39:35.931Z"</span>,
      <span class="hljs-string">"id"</span>: <span class="hljs-string">"57fbbdb0a2400000"</span>
    }
  ]
}
</code></pre>
<h2 id="建立扩展对象">建立扩展对象</h2>
<p>通过 orm 定义 hasOne 和 hasMany，可以定义对象之间的关联关系，并在 API 上体现出来，例如：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8
9</div><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">db</span> =&gt;</span> {
  <span class="hljs-keyword">var</span> Person = db.models.person;

  <span class="hljs-keyword">var</span> Pet = db.define(<span class="hljs-string">'pet'</span>, {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>
  });

  Person.hasMany(<span class="hljs-string">'pets'</span>, Pet);
};
</code></pre>
<h2 id="扩展对象访问-API">扩展对象访问 API</h2>
<p>下面是扩展对象的 API 定义：</p>
<table>
<thead>
<tr>
<th>url</th>
<th>method</th>
<th>action</th>
</tr>
</thead>
<tbody>
<tr>
<td>/1.0/:className/:id/:extendName</td>
<td>PUT</td>
<td>设置扩展对象</td>
</tr>
<tr>
<td>/1.0/:className/:id/:extendName</td>
<td>POST</td>
<td>创建扩展对象</td>
</tr>
<tr>
<td>/1.0/:className/:id/:extendName/:rid</td>
<td>GET</td>
<td>读取扩展对象</td>
</tr>
<tr>
<td>/1.0/:className/:id/:extendName/:rid</td>
<td>PUT</td>
<td>修改扩展对象</td>
</tr>
<tr>
<td>/1.0/:className/:id/:extendName/:rid</td>
<td>DELETE</td>
<td>删除扩展对象</td>
</tr>
<tr>
<td>/1.0/:className/:id/:extendName</td>
<td>GET</td>
<td>查询扩展对象列表</td>
</tr>
</tbody>
</table>
<h3 id="设置扩展对象">设置扩展对象</h3>
<p>设置扩展对象是将两个独立的对象建立联系。比如 tom 领养了一只叫 cat 的宠物，可以用下面的操作实现：</p>
<pre><code class="lang-sh"><div class="line-numbers">1
2
3
4</div>curl -X PUT \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"id": "57fbbdb0a2400007"}'</span> \
  http://localhost/1.0/person/57fbbdb0a2400000/pets
</code></pre>
<p>在调用里需要在 body 内指定 cat 的 id。</p>
<h3 id="创建扩展对象">创建扩展对象</h3>
<p>直接创建扩展对象，可以在创建对象的同时，建立对象之间的联系。比如：</p>
<pre><code class="lang-sh"><div class="line-numbers">1
2
3
4</div>curl -X POST \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"name": "cat"}'</span> \
  http://localhost/1.0/person/57fbbdb0a2400000/pets
</code></pre>
<p>将创建一只名叫 cat 的宠物，并建立与 tom 的关联关系。</p>
<h3 id="读取扩展对象">读取扩展对象</h3>
<p>读取扩展对象与读取基础对象很相似，也同样支持 keys 选项：</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person/57fbbdb0a2400000/pets/57fbbdb0a2400007
</code></pre>
<h3 id="修改扩展对象">修改扩展对象</h3>
<p>读取扩展对象与读取基础对象很相似：</p>
<pre><code class="lang-sh"><div class="line-numbers">1
2
3
4</div>curl -X PUT \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"name": "cat 1"}'</span> \
  http://localhost/1.0/person/57fbbdb0a2400000/pets/57fbbdb0a2400007
</code></pre>
<h3 id="删除扩展对象">删除扩展对象</h3>
<p>删除扩展对象不会删除对象本身，只会解除对象之间的关系：</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X DETELE http://localhost/1.0/person/57fbbdb0a2400000/pets/57fbbdb0a2400007
</code></pre>
<h3 id="查询扩展对象列表">查询扩展对象列表</h3>
<p>查询扩展对象列表与查询基础对象列表很相似，也同样支持 keys 以及条件过滤等选项：</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person/57fbbdb0a2400000/pets
</code></pre>
<h2 id="ACL">ACL</h2>
<p>可以通过定义 Model 的 ACL 控制数据权限。比如:</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</div><span class="hljs-keyword">const</span> orm = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fib-orm'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">db</span> =&gt;</span> {
  db.define(<span class="hljs-string">'blog'</span>, {
    <span class="hljs-attr">title</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-attr">detail</span>: <span class="hljs-built_in">String</span>，
    <span class="hljs-attr">note</span>: <span class="hljs-built_in">String</span>
  }, {
    <span class="hljs-attr">ACL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">session</span>) </span>{
      <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"*"</span>: {
          <span class="hljs-string">"*"</span>: <span class="hljs-literal">false</span>
        },
        <span class="hljs-string">"57fbbdb0a2400000"</span>: {
          <span class="hljs-string">"*"</span>: <span class="hljs-literal">true</span>
        },
        <span class="hljs-string">"roles"</span>: {
          <span class="hljs-string">"user"</span>: {
            <span class="hljs-string">"read"</span>: <span class="hljs-literal">true</span>
          }
        }
      };
    }
  });
};
</code></pre>
<p>如果定义 Model 时未指定 ACL，则等同于设定了缺省权限：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5</div>{
  <span class="hljs-string">"*"</span>: {
    <span class="hljs-string">"*"</span>: <span class="hljs-literal">true</span>
  }
}
</code></pre>
<h3 id="主体">主体</h3>
<p>ACL 主体描述有三种，用户 <code>id</code>，用户 <code>role</code> 和 <code>*</code>，<code>id</code> 表示一个具体的用户，<code>role</code> 表示具有某个角色的用户，<code>*</code> 表示所有用户：</p>
<table>
<thead>
<tr>
<th>主体</th>
<th>描述</th>
<th>优先级</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>具体用户的 id</td>
<td>1</td>
</tr>
<tr>
<td>role</td>
<td>用户组名</td>
<td>2</td>
</tr>
<tr>
<td>*</td>
<td>全体</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>在检查权限时，首先会匹配 <code>id</code> 对应的权限，如果未指定，则匹配用户 <code>role</code> 对应的权限，如果仍为指定，则查看是否指定了 <code>*</code> 的权限，如果 <code>*</code> 也未指定，则没有权限。</p>
<p>比如上面的权限配置，指定了 <code>user</code> 用户组可以阅读，用户 <code>57fbbdb0a2400000</code> 拥有全部权限，而其它用户没有任何权限。</p>
<h3 id="权限">权限</h3>
<p>ACL 根据 API 行为将权限分类五种：</p>
<table>
<thead>
<tr>
<th>权限</th>
<th>描述</th>
<th>允许类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td>创建对象</td>
<td>true / false / array</td>
</tr>
<tr>
<td>read</td>
<td>读取对象</td>
<td>true / false / array</td>
</tr>
<tr>
<td>write</td>
<td>修改对象</td>
<td>true / false / array</td>
</tr>
<tr>
<td>delete</td>
<td>删除对象</td>
<td>true / false</td>
</tr>
<tr>
<td>find</td>
<td>查询对象列表</td>
<td>true / false</td>
</tr>
<tr>
<td>*</td>
<td>匹配所有权限</td>
<td>true / false / array</td>
</tr>
</tbody>
</table>
<p>权限制定 <code>true</code> 为允许访问，为 <code>false</code> 为禁止访问，为 <code>array</code> 为只允许指定的字段的访问。<code>delete</code> 和 <code>find</code> 不接受 <code>array</code>，如果设置了 <code>array</code> 则视同为 <code>true</code>。如果指定的权限不存在，则匹配同主体下的 <code>*</code> 权限。若都不存在，再一次查询下一优先级的主体。</p>
<p>比如以上例子，如果需要设定 <code>user</code> 只允许读取 <code>title</code> 和 <code>detail</code>，其他人可以读取  <code>title</code>，则可以这样设定：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8
9
10
11
12
13
14</div>{
  <span class="hljs-string">"*"</span>: {
    <span class="hljs-string">"*"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"read"</span>: [<span class="hljs-string">'title'</span>]
  },
  <span class="hljs-string">"57fbbdb0a2400000"</span>: {
    <span class="hljs-string">"*"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"roles"</span>: {
    <span class="hljs-string">"user"</span>: {
      <span class="hljs-string">"read"</span>: [<span class="hljs-string">'title'</span>, <span class="hljs-string">'detail'</span>]
    }
  }
}
</code></pre>
<h3 id="对象权限">对象权限</h3>
<p>在 Model 上设定的是整个类的权限，如果需要对具体的对象设定权限，可以通过设置 OACL 来实现：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</div><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">db</span> =&gt;</span> {
  db.define(<span class="hljs-string">'person'</span>, {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-attr">sex</span>: [<span class="hljs-string">"male"</span>, <span class="hljs-string">"female"</span>],
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">Number</span>
  }, {
    <span class="hljs-attr">ACL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">session</span>) </span>{
      <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"*"</span>: {
          <span class="hljs-string">"*"</span>: <span class="hljs-literal">false</span>
        }
      }
    },
    <span class="hljs-attr">OACL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">session</span>) </span>{
      <span class="hljs-keyword">var</span> _acl = {};
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.id === session.id)
        _acl[session.id] = {
          <span class="hljs-string">"*"</span>: <span class="hljs-literal">true</span>
        };

      <span class="hljs-keyword">return</span> _acl;
    }
  });
};
</code></pre>
<p>在这个例子中，当访问者是对象本人时，将被允许全部操作，否则禁止一切访问。会按照以下步骤检查权限：</p>
<ul>
<li><code>person[57fbbdb0a2400000]</code> =&gt; <code>OACL</code></li>
<li><code>person</code> =&gt; <code>ACL</code></li>
</ul>
<h3 id="扩展对象权限">扩展对象权限</h3>
<p>扩展对象的访问权限控制和基础对象权限相似，唯一不同的是在 ACL 需要单独指定：</p>
<pre><code class="lang-JavaScript"><div class="line-numbers">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</div><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">db</span> =&gt;</span> {
  <span class="hljs-keyword">var</span> Person = db.define(<span class="hljs-string">'person'</span>, {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-attr">sex</span>: [<span class="hljs-string">"male"</span>, <span class="hljs-string">"female"</span>],
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">Number</span>
  },{
    <span class="hljs-attr">ACL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">session</span>) </span>{
      <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"*"</span>: {
          <span class="hljs-string">"read"</span>: [<span class="hljs-string">'name'</span>, <span class="hljs-string">'sex'</span>],
          <span class="hljs-string">"extends"</span>: {
            <span class="hljs-string">"pets"</span>: {
              <span class="hljs-string">"read"</span>: <span class="hljs-literal">true</span>,
              <span class="hljs-string">"find"</span>: <span class="hljs-literal">true</span>
            }
          }
        }
      }
    },
    <span class="hljs-attr">OACL</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">session</span>) </span>{
      <span class="hljs-keyword">var</span> _acl = {};
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.id === session.id)
        _acl[session.id] = {
          <span class="hljs-string">"*"</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-string">"extends"</span>: {
            <span class="hljs-string">"pets"</span>: {
              <span class="hljs-string">"*"</span>: <span class="hljs-literal">true</span>
            }
          }
        };

      <span class="hljs-keyword">return</span> _acl;
    }
  });

  <span class="hljs-keyword">var</span> Pet = db.define(<span class="hljs-string">'pet'</span>, {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>
  });

  Person.hasMany(<span class="hljs-string">'pets'</span>, Pet);
};
</code></pre>
<p>这个定义中，任何人都可以查阅个人信息的 <code>name</code> 和 <code>sex</code>，并自由查阅和搜索他的 <code>pets</code>，用户本人可以操作自己的所有数据，以及拥有自己宠物信息的全部权限。</p>
<p>在检查扩展对象的访问权限时，会分别检查对象权限和扩展对象权限。比如以下请求：</p>
<pre><code class="lang-sh"><div class="line-numbers">1</div>curl -X GET http://localhost/1.0/person/57fbbdb0a2400000/pets/57fbbdb0a2400007
</code></pre>
<p>会按照以下步骤检查权限：</p>
<ul>
<li><code>pets[57fbbdb0a2400007]</code> =&gt; <code>OACL</code></li>
<li><code>person[57fbbdb0a2400000]</code> =&gt; <code>OACL</code> =&gt; <code>extends</code> =&gt; <code>pets</code></li>
<li><code>person</code> =&gt; <code>ACL</code> =&gt; <code>extends</code> =&gt; <code>pets</code></li>
<li><code>pets</code> =&gt; <code>ACL</code></li>
</ul>
<h2 id="Function">Function</h2>
<p>可以为 Model 定义 api，对于复杂数据操作，可以通过自定义 Function 来完成。</p>
<p>绝大多数权限可以通过 ACL 控制完成，不需要通过 Function 来完成基于对象的权限。Function 可用于完成基于数据的权限，比如根据审批状态，赋予不同用户组权限。以及多项修改，比如需要修改多条数据库记录。</p>
<h2 id="绘制数据模型">绘制数据模型</h2>
<p>在完成数据定义以后，可以使用 <code>app.diagram()</code> 绘制数据模型的 <code>svg</code> 格式类图，保存至文件会得到类似下面的图像：
<img src="./demo/diagram.svg" alt="diagram"></p>
 </div><div class="sidebar hidden-sm hidden-xs hidden-md"><div id=toc></div></div></div></div><div class=footer><div class=container>&copy; Copyright 2012-2021 fibjs.org | <a href=../../../support.html>支持我们</a></div></div><a id=back-to-top href=# class="btn btn-default btn-lg back-to-top" role=button title="Click to return on the top page" data-toggle=tooltip data-placement=left><span class="glyphicon glyphicon-chevron-up"></span></a><script type=text/javascript src=https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js></script><script type=text/javascript src=../../../js/common.js></script><script type=text/javascript src=../../../js/docs.js></script></body></html>